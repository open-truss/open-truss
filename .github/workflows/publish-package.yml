name: Publish Package to npmjs
on:
  push:
    branches:
      - fix-package-publishing
permissions:
  actions: 'write'
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      # Setup .npmrc file to publish to npm
      - uses: actions/setup-node@v3
        with:
          node-version: '20.x'
          registry-url: 'https://registry.npmjs.org'
      - name: Skip if package.json version unchanged
        run: |
          if git diff ${{ github.event.before }} ${{ github.sha }} -- packages/open-truss/package.json | grep "[[:space:]][[:space:]]\"version"; then
              echo "package.json version changed. Continuting with package publishing"
          else
              echo "package.json version has not changed. Skipping package publishing"
              gh run cancel ${{ github.run_id }}
              gh run watch ${{ github.run_id }}
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: Run CI
        working-directory: ./packages/open-truss
        run: npm ci
      - name: Publish Package
        working-directory: ./packages/open-truss
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
