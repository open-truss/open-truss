#!/bin/bash

terminate_processes() {
  echo "Terminating processes..."
  pkill -P $$
}

# Trap SIGINT and SIGTERM and call the function to terminate tsc processes
trap 'terminate_processes' SIGINT SIGTERM

# Check if the --help or -h flag is passed
if [ "$1" == "--help" ] || [ "$1" == "-h" ]; then
  echo "Usage: open-truss start"
  echo "Usage: open-truss start [--tsc-watch | -t]"
  exit 0
fi

# Directory of open-truss project
package_dir="${PACKAGE_DIR:-.}"
cd $package_dir

PACKAGE_DIR=$package_dir bin/append-package-json-to-dist

# Check if the --help or -h flag is passed
if [ "$1" == "--tsc-watch" ] || [ "$1" == "-t" ]; then
  (PACKAGE_DIR=$package_dir bin/tsc-watch) &
fi

app_dir=$package_dir/app
cd $app_dir

# Run dev server
(npm run dev) &

wait
